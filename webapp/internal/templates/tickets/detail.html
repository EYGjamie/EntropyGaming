<!-- webapp/internal/templates/tickets/detail.html -->
{% extends "base.html" %}

{% block title %}Ticket #{{ ticket.ticket_id }} - Tickets{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tickets.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{{ url_for('dashboard.index') }}">Dashboard</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{{ url_for('tickets.index') }}">Tickets</a>
            </li>
            <li class="breadcrumb-item active">Ticket #{{ ticket.ticket_id }}</li>
        </ol>
    </nav>

    <!-- Ticket Header -->
    <div class="ticket-detail-header mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="gradient-text">
                    <i class="bi bi-ticket"></i> Ticket #{{ ticket.ticket_id }}
                </h1>
                <div class="ticket-meta">
                    <span class="badge {{ ticket.ticket_status | status_badge_class }} me-2">
                        {% if ticket.ticket_status == 'open' %}
                            <i class="bi bi-circle-fill"></i> Offen
                        {% elif ticket.ticket_status == 'closed' %}
                            <i class="bi bi-check-circle"></i> Geschlossen
                        {% else %}
                            <i class="bi bi-clock"></i> {{ ticket.ticket_status or 'Unbekannt' }}
                        {% endif %}
                    </span>
                    {% if ticket.ticket_bereich %}
                    <span class="badge bg-secondary me-2">{{ ticket.ticket_bereich }}</span>
                    {% endif %}
                    <span class="text">
                        Erstellt: {{ ticket.ticket_erstellungszeit   if ticket.ticket_erstellungszeit else 'Unbekannt' }}
                    </span>
                </div>
            </div>
            <div class="col-md-4 text-md-end">
                <a href="{{ url_for('tickets.index') }}" class="btn btn-outline-entropy">
                    <i class="bi bi-arrow-left"></i> Zurück zur Übersicht
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Ticket Details -->
        <div class="col-lg-8 mb-4">
            <!-- Ticket Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-info-circle"></i> Ticket-Details
                </div>
                <div class="card-body">
                    <div class="ticket-fields">
                        {% if ticket.ticket_modal_field_one %}
                        <div class="field-group mb-3">
                            <div class="field-value">{{ ticket.ticket_modal_field_one }}</div>
                        </div>
                        {% endif %}
                        
                        {% if ticket.ticket_modal_field_two %}
                        <div class="field-group mb-3">
                            <div class="field-value">{{ ticket.ticket_modal_field_two }}</div>
                        </div>
                        {% endif %}
                        
                        {% if ticket.ticket_modal_field_three %}
                        <div class="field-group mb-3">
                            <div class="field-value">{{ ticket.ticket_modal_field_three }}</div>
                        </div>
                        {% endif %}
                        
                        {% if ticket.ticket_modal_field_four %}
                        <div class="field-group mb-3">
                            <div class="field-value">{{ ticket.ticket_modal_field_four }}</div>
                        </div>
                        {% endif %}
                        
                        {% if ticket.ticket_modal_field_five %}
                        <div class="field-group mb-3">
                            <div class="field-value">{{ ticket.ticket_modal_field_five }}</div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Transcript -->
            {% if transcript_data %}
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-chat-text"></i> Ticket-Transkript</span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleTranscriptExpand()">
                            <i class="bi bi-arrows-expand" id="transcriptExpandIcon"></i> Vollbild
                        </button>
                    </div>
                    <div class="card-body transcript-container" id="transcriptContainer">
                        <div class="transcript-content">
                            {% if transcript_data.messages %}
                                {% for message in transcript_data.messages %}
                                <div class="message-item">
                                    <div class="message-header">
                                        <div class="message-author">
                                            {% if message.avatar_url %}
                                            <img src="{{ message.avatar_url }}" alt="{{ message.display_name }}" class="author-avatar">
                                            {% else %}
                                            <div class="author-avatar-placeholder">
                                                {{ message.display_name[0]|upper if message.display_name else '?' }}
                                            </div>
                                            {% endif %}
                                            <strong>{{ message.display_name }}</strong>
                                            {% if message.nickname and message.nickname != message.username %}
                                            <span class="username-hint">(@{{ message.username }})</span>
                                            {% endif %}
                                        </div>
                                        <div class="message-time">{{ message.formatted_timestamp }}</div>
                                    </div>
                                    <div class="message-content">{{ message.message }}</div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="no-messages">
                                    <i class="bi bi-chat-text-fill"></i>
                                    <p>Keine Nachrichten im Transkript gefunden.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4 mb-4">
            <!-- Ticket Info -->
            <div class="card mb-3">
                <div class="card-header">
                    <i class="bi bi-info-circle"></i> Ticket-Informationen
                </div>
                <div class="card-body">
                    <div class="info-list">
                        <div class="info-item">
                            <label>Ticket-ID:</label>
                            <span>#{{ ticket.ticket_id }}</span>
                        </div>
                        <div class="info-item">
                            <label>Status:</label>
                            <span class="badge {{ ticket.ticket_status | status_badge_class }}">
                                {{ ticket.ticket_status or 'Unbekannt' }}
                            </span>
                        </div>
                        <div class="info-item">
                            <label>Bereich:</label>
                            <span>{{ ticket.ticket_bereich or 'Nicht angegeben' }}</span>
                        </div>
                        <div class="info-item">
                            <label>Ersteller:</label>
                            <span>{{ ticket.ticket_ersteller_name or 'Unbekannt' }}</span>
                        </div>
                        <div class="info-item">
                            <label>Erstellt am:</label>
                            <span>{{ ticket.ticket_erstellungszeit   if ticket.ticket_erstellungszeit else 'Unbekannt' }}</span>
                        </div>
                        {% if ticket.ticket_bearbeiter_name %}
                        <div class="info-item">
                            <label>Bearbeiter:</label>
                            <span>{{ ticket.ticket_bearbeiter_name }}</span>
                        </div>
                        <div class="info-item">
                            <label>Bearbeitet am:</label>
                            <span>{{ ticket.ticket_bearbeitungszeit   if ticket.ticket_bearbeitungszeit else 'Unbekannt' }}</span>
                        </div>
                        {% endif %}
                        {% if ticket.ticket_schliesser_name %}
                        <div class="info-item">
                            <label>Geschlossen von:</label>
                            <span>{{ ticket.ticket_schliesser_name }}</span>
                        </div>
                        <div class="info-item">
                            <label>Geschlossen am:</label>
                            <span>{{ ticket.ticket_schliesszeit   if ticket.ticket_schliesszeit else 'Unbekannt' }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_js %}
<script src="{{ url_for('static', filename='js/tickets.js') }}"></script>
{% endblock %}

{% block scripts %}
<script>
function toggleTranscriptExpand() {
    const container = document.getElementById('transcriptContainer');
    const icon = document.getElementById('transcriptExpandIcon');
    
    if (container.classList.contains('transcript-fullscreen')) {
        container.classList.remove('transcript-fullscreen');
        icon.className = 'bi bi-arrows-expand';
    } else {
        container.classList.add('transcript-fullscreen');
        icon.className = 'bi bi-arrows-collapse';
    }
}

function copyTicketUrl() {
    navigator.clipboard.writeText(window.location.href).then(() => {
        // Show toast or notification
        const toast = document.createElement('div');
        toast.className = 'toast position-fixed top-0 end-0 m-3';
        toast.innerHTML = `
            <div class="toast-header bg-success text-white">
                <i class="bi bi-check-circle me-2"></i>
                <strong class="me-auto">Erfolg</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                Ticket-URL wurde in die Zwischenablage kopiert.
            </div>
        `;
        
        document.body.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        toast.addEventListener('hidden.bs.toast', () => toast.remove());
    });
}

function downloadTranscript() {
    // Create a downloadable text file from transcript
    const messages = document.querySelectorAll('.message-item');
    let transcriptText = `Ticket #{{ ticket.ticket_id }} - Transkript\n\n`;
    
    messages.forEach(message => {
        const author = message.querySelector('.message-author strong').textContent;
        const time = message.querySelector('.message-time').textContent;
        const content = message.querySelector('.message-content').textContent;
        
        transcriptText += `[${time}] ${author}: ${content}\n\n`;
    });
    
    const blob = new Blob([transcriptText], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ticket-{{ ticket.ticket_id }}-transcript.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Auto-scroll to bottom of transcript
document.addEventListener('DOMContentLoaded', function() {
    const transcript = document.querySelector('.transcript-content');
    if (transcript) {
        transcript.scrollTop = transcript.scrollHeight;
    }
});
</script>
{% endblock %}