<!-- webapp/internal/templates/forum/edit_post.html -->
{% extends "base.html" %}

{% block title %}Post bearbeiten - Forum{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/forum.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/forum-editor.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="forum-editor-container">
        <div class="editor-header">
            <h1>
                <i class="bi bi-pencil-square"></i> 
                Post bearbeiten
            </h1>
            <div class="header-actions">
                <a href="{{ url_for('forum.view_post', post_id=post.id) }}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Zur√ºck zum Post
                </a>
                <a href="{{ url_for('forum.index') }}" class="btn btn-outline">
                    <i class="bi bi-house"></i> Forum
                </a>
            </div>
        </div>

        <!-- Edit Notice -->
        <div class="edit-notice">
            <div class="notice-content">
                <i class="bi bi-info-circle"></i>
                <div>
                    <strong>Post wird bearbeitet</strong>
                    <p>Urspr√ºnglich erstellt {{ post.created_at|datetime_format }}{% if post.updated_at and post.updated_at != post.created_at %}, zuletzt bearbeitet {{ post.updated_at|datetime_format }}{% endif %}</p>
                </div>
            </div>
        </div>

        <form method="POST" enctype="multipart/form-data" id="editPostForm" class="editor-form">
            <div class="form-layout">
                <!-- Left Column: Main Editor -->
                <div class="editor-main">
                    <!-- Basic Information -->
                    <div class="form-section">
                        <div class="form-section-header">
                            <h3><i class="bi bi-info-circle"></i> Grundinformationen</h3>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="title" class="form-label">
                                    <i class="bi bi-type"></i> Titel *
                                </label>
                                <input type="text" 
                                       id="title" 
                                       name="title" 
                                       class="form-input" 
                                       placeholder="Gib deinem Post einen aussagekr√§ftigen Titel..."
                                       value="{{ post.title }}"
                                       maxlength="255"
                                       required>
                                <div class="form-hint">
                                    <span id="titleCounter">{{ post.title|length }}/255</span> Zeichen
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="category_id" class="form-label">
                                    <i class="bi bi-tag"></i> Kategorie
                                </label>
                                <select id="category_id" name="category_id" class="form-select">
                                    <option value="">-- Keine Kategorie --</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}" 
                                            {% if post.category_id == category.id %}selected{% endif %}>
                                        {{ category.name }}
                                        {% if category.required_roles %}
                                        üîí
                                        {% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-hint">Optional: Ordne deinen Post einer Kategorie zu</div>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Section -->
                    <div class="form-section">
                        <div class="form-section-header">
                            <h3><i class="bi bi-card-text"></i> Kurzzusammenfassung</h3>
                            <button type="button" class="btn btn-ai" id="generateSummaryBtn">
                                <i class="bi bi-magic"></i> AI generieren
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <textarea id="summary" 
                                      name="summary" 
                                      class="form-textarea summary-input" 
                                      placeholder="Eine kurze Zusammenfassung deines Posts (max. 150 Zeichen)..."
                                      maxlength="150"
                                      rows="3">{{ post.summary or '' }}</textarea>
                            <div class="form-hint">
                                <span id="summaryCounter">{{ (post.summary or '')|length }}/150</span> Zeichen
                                <div class="ai-status" id="aiStatus" style="display: none;">
                                    <i class="bi bi-robot"></i> <span class="status-text">Wird generiert...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Content Editor -->
                    <div class="form-section">
                        <div class="form-section-header">
                            <h3><i class="bi bi-file-text"></i> Inhalt *</h3>
                            <div class="editor-mode-toggle">
                                <button type="button" class="mode-btn active" data-mode="write">
                                    <i class="bi bi-pencil"></i> Schreiben
                                </button>
                                <button type="button" class="mode-btn" data-mode="preview">
                                    <i class="bi bi-eye"></i> Vorschau
                                </button>
                            </div>
                        </div>

                        <!-- Formatting Toolbar -->
                        <div class="markdown-toolbar">
                            <div class="toolbar-group">
                                <button type="button" class="toolbar-btn" data-action="bold" title="Fett (Ctrl+B)">
                                    <i class="bi bi-type-bold"></i>
                                </button>
                                <button type="button" class="toolbar-btn" data-action="italic" title="Kursiv (Ctrl+I)">
                                    <i class="bi bi-type-italic"></i>
                                </button>
                                <button type="button" class="toolbar-btn" data-action="strikethrough" title="Durchgestrichen">
                                    <i class="bi bi-type-strikethrough"></i>
                                </button>
                            </div>
                            
                            <div class="toolbar-group">
                                <button type="button" class="toolbar-btn" data-action="heading" title="√úberschrift">
                                    <i class="bi bi-type-h1"></i>
                                </button>
                                <button type="button" class="toolbar-btn" data-action="quote" title="Zitat">
                                    <i class="bi bi-chat-square-quote"></i>
                                </button>
                                <button type="button" class="toolbar-btn" data-action="code" title="Code">
                                    <i class="bi bi-code"></i>
                                </button>
                                <button type="button" class="toolbar-btn" data-action="codeblock" title="Codeblock">
                                    <i class="bi bi-code-square"></i>
                                </button>
                            </div>
                            
                            <div class="toolbar-group">
                                <button type="button" class="toolbar-btn" data-action="link" title="Link">
                                    <i class="bi bi-link-45deg"></i>
                                </button>
                                <button type="button" class="toolbar-btn" data-action="image" title="Bild">
                                    <i class="bi bi-image"></i>
                                </button>
                                <button type="button" class="toolbar-btn" data-action="list" title="Liste">
                                    <i class="bi bi-list-ul"></i>
                                </button>
                                <button type="button" class="toolbar-btn" data-action="table" title="Tabelle">
                                    <i class="bi bi-table"></i>
                                </button>
                            </div>
                            
                            <div class="toolbar-group">
                                <button type="button" class="toolbar-btn" data-action="help" title="Markdown Hilfe">
                                    <i class="bi bi-question-circle"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Editor Area -->
                        <div class="editor-area">
                            <textarea id="content" 
                                      name="content" 
                                      class="form-textarea markdown-editor" 
                                      placeholder="Schreibe hier den Inhalt deines Posts... Du kannst Markdown verwenden!"
                                      rows="20"
                                      required>{{ post.content }}</textarea>
                            
                            <div id="preview" class="markdown-preview" style="display: none;">
                                <div class="preview-content">
                                    <p class="text-muted"><i class="bi bi-eye"></i> Vorschau wird geladen...</p>
                                </div>
                            </div>
                        </div>

                        <div class="editor-footer">
                            <div class="editor-stats">
                                <span id="wordCount">0 W√∂rter</span>
                                <span id="charCount">0 Zeichen</span>
                            </div>
                            <div class="markdown-hint">
                                <i class="bi bi-info-circle"></i>
                                <a href="#" onclick="showMarkdownHelp()">Markdown Syntax</a> wird unterst√ºtzt
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Settings & Attachments -->
                <div class="editor-sidebar">
                    <!-- Existing Attachments -->
                    {% if attachments %}
                    <div class="sidebar-section">
                        <div class="sidebar-section-header">
                            <h4><i class="bi bi-paperclip"></i> Vorhandene Anh√§nge</h4>
                        </div>
                        
                        <div class="existing-attachments">
                            {% for attachment in attachments %}
                            <div class="file-item existing-file" data-attachment-id="{{ attachment.id }}">
                                <div class="file-info">
                                    {% set file_ext = attachment.original_filename.split('.')[-1].lower() %}
                                    {% if file_ext in ['jpg', 'jpeg', 'png', 'gif'] %}
                                        <i class="bi bi-image text-info"></i>
                                    {% elif file_ext == 'pdf' %}
                                        <i class="bi bi-file-pdf text-danger"></i>
                                    {% elif file_ext in ['doc', 'docx'] %}
                                        <i class="bi bi-file-word text-primary"></i>
                                    {% else %}
                                        <i class="bi bi-file-earmark text-muted"></i>
                                    {% endif %}
                                    <div class="file-details">
                                        <span class="filename">{{ attachment.original_filename }}</span>
                                        <span class="filesize">{{ (attachment.file_size / 1024)|round(1) }} KB</span>
                                    </div>
                                </div>
                                <button type="button" class="remove-file-btn" onclick="removeExistingFile({{ attachment.id }})">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- New Attachments -->
                    <div class="sidebar-section">
                        <div class="sidebar-section-header">
                            <h4><i class="bi bi-plus-circle"></i> Neue Anh√§nge hinzuf√ºgen</h4>
                        </div>
                        
                        <div class="attachments-area">
                            <div class="file-upload-area" id="fileUploadArea">
                                <input type="file" 
                                       name="attachments" 
                                       id="attachments" 
                                       multiple 
                                       accept=".txt,.pdf,.png,.jpg,.jpeg,.gif,.doc,.docx,.xlsx,.pptx,.zip,.rar"
                                       class="file-input">
                                <label for="attachments" class="file-upload-label">
                                    <i class="bi bi-cloud-upload"></i>
                                    <span>Neue Dateien hinzuf√ºgen</span>
                                    <small>Max. 10MB pro Datei</small>
                                </label>
                            </div>
                            
                            <div id="fileList" class="file-list">
                                <!-- New files will be listed here -->
                            </div>
                        </div>
                    </div>

                    <!-- Edit Information -->
                    <div class="sidebar-section">
                        <div class="sidebar-section-header">
                            <h4><i class="bi bi-info-circle"></i> Bearbeitungsinfo</h4>
                        </div>
                        
                        <div class="edit-info">
                            <div class="info-item">
                                <label>Erstellt:</label>
                                <span>{{ post.created_at|datetime_format }}</span>
                            </div>
                            {% if post.updated_at and post.updated_at != post.created_at %}
                            <div class="info-item">
                                <label>Zuletzt bearbeitet:</label>
                                <span>{{ post.updated_at|datetime_format }}</span>
                            </div>
                            {% endif %}
                            <div class="info-item">
                                <label>Autor:</label>
                                <span>{{ post.author_display_name or post.author_name }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="sidebar-section">
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary btn-block">
                                <i class="bi bi-check-circle"></i> 
                                √Ñnderungen speichern
                            </button>
                            
                            <button type="button" class="btn btn-outline btn-block" onclick="saveDraft()">
                                <i class="bi bi-save"></i> Als Entwurf speichern
                            </button>
                            
                            <a href="{{ url_for('forum.view_post', post_id=post.id) }}" 
                               class="btn btn-secondary btn-block">
                                <i class="bi bi-x-lg"></i> Abbrechen
                            </a>
                            
                            {% if user.has_management_role() %}
                            <hr class="sidebar-divider">
                            <button type="button" class="btn btn-danger btn-block" onclick="deletePost()">
                                <i class="bi bi-trash"></i> Post l√∂schen
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Markdown Help Modal (reuse from create template) -->
<div id="markdownHelpModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="bi bi-book"></i> Markdown Syntax Hilfe</h3>
            <button type="button" class="modal-close" onclick="closeMarkdownHelp()">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <!-- Same content as create template -->
            <div class="markdown-help-content">
                <div class="help-section">
                    <h4>Text-Formatierung</h4>
                    <div class="help-examples">
                        <div class="help-item">
                            <code>**fett**</code> ‚Üí <strong>fett</strong>
                        </div>
                        <div class="help-item">
                            <code>*kursiv*</code> ‚Üí <em>kursiv</em>
                        </div>
                        <div class="help-item">
                            <code>~~durchgestrichen~~</code> ‚Üí <del>durchgestrichen</del>
                        </div>
                        <div class="help-item">
                            <code>`code`</code> ‚Üí <code>code</code>
                        </div>
                    </div>
                </div>
                
                <!-- Add more help sections as in create template -->
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="bi bi-exclamation-triangle"></i> Post l√∂schen</h3>
            <button type="button" class="modal-close" onclick="closeDeleteModal()">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>Sind Sie sicher, dass Sie diesen Post permanent l√∂schen m√∂chten?</p>
            <div class="warning-box">
                <i class="bi bi-exclamation-triangle"></i>
                <p><strong>Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!</strong><br>
                Der Post, alle Kommentare und Anh√§nge werden endg√ºltig gel√∂scht.</p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                <i class="bi bi-trash"></i> Endg√ºltig l√∂schen
            </button>
            <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">
                <i class="bi bi-x"></i> Abbrechen
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block page_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
<script>
// Reuse ForumEditor class from create template
// (Include the same ForumEditor class implementation)

// Edit-specific functionality
document.addEventListener('DOMContentLoaded', function() {
    new ForumEditor();
    
    // Generate summary button
    document.getElementById('generateSummaryBtn').addEventListener('click', generateSummary);
    
    // Form validation
    document.getElementById('editPostForm').addEventListener('submit', function(e) {
        const title = document.getElementById('title').value.trim();
        const content = document.getElementById('content').value.trim();
        
        if (!title || !content) {
            e.preventDefault();
            alert('Bitte f√ºllen Sie Titel und Inhalt aus.');
            return;
        }
        
        // Show saving indicator
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="bi bi-hourglass"></i> Wird gespeichert...';
    });
});

// AI Summary Generation (same as create template)
async function generateSummary() {
    const content = document.getElementById('content').value.trim();
    const summaryInput = document.getElementById('summary');
    const generateBtn = document.getElementById('generateSummaryBtn');
    const aiStatus = document.getElementById('aiStatus');
    
    if (!content) {
        alert('Bitte geben Sie zuerst den Inhalt des Posts ein.');
        return;
    }
    
    // Show loading state
    generateBtn.disabled = true;
    generateBtn.innerHTML = '<i class="bi bi-hourglass"></i> Generiert...';
    aiStatus.style.display = 'flex';
    aiStatus.querySelector('.status-text').textContent = 'Zusammenfassung wird generiert...';
    
    try {
        const response = await fetch('/forum/generate-summary', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ content: content })
        });
        
        const data = await response.json();
        
        if (data.success) {
            summaryInput.value = data.summary;
            summaryInput.dispatchEvent(new Event('input')); // Trigger counter update
            aiStatus.querySelector('.status-text').textContent = 'Zusammenfassung generiert!';
            aiStatus.style.color = 'var(--success-color)';
            
            setTimeout(() => {
                aiStatus.style.display = 'none';
                aiStatus.style.color = '';
            }, 3000);
        } else {
            throw new Error(data.error || 'Unbekannter Fehler');
        }
    } catch (error) {
        console.error('Error generating summary:', error);
        aiStatus.querySelector('.status-text').textContent = 'Fehler beim Generieren: ' + error.message;
        aiStatus.style.color = 'var(--error-color)';
        
        setTimeout(() => {
            aiStatus.style.display = 'none';
            aiStatus.style.color = '';
        }, 5000);
    } finally {
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<i class="bi bi-magic"></i> AI generieren';
    }
}

// Delete functionality
function deletePost() {
    document.getElementById('deleteModal').style.display = 'flex';
    
    document.getElementById('confirmDeleteBtn').onclick = function() {
        // Implement delete functionality
        fetch(`/forum/post/{{ post.id }}/delete`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '{{ url_for("forum.index") }}';
            } else {
                alert('Fehler beim L√∂schen: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Fehler beim L√∂schen des Posts.');
        });
    };
}

function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
}

// Remove existing file
function removeExistingFile(attachmentId) {
    if (confirm('Datei wirklich entfernen?')) {
        fetch(`/forum/delete-attachment/${attachmentId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelector(`[data-attachment-id="${attachmentId}"]`).remove();
                showNotification('Datei entfernt', 'success');
            } else {
                alert('Fehler beim Entfernen der Datei: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Fehler beim Entfernen der Datei.');
        });
    }
}

// Helper functions (same as create template)
function showMarkdownHelp() {
    document.getElementById('markdownHelpModal').style.display = 'flex';
}

function closeMarkdownHelp() {
    document.getElementById('markdownHelpModal').style.display = 'none';
}

function saveDraft() {
    // Auto-save functionality
    localStorage.setItem('forum_post_edit_{{ post.id }}', JSON.stringify({
        title: document.getElementById('title').value,
        content: document.getElementById('content').value,
        summary: document.getElementById('summary').value,
        category: document.getElementById('category_id').value,
        timestamp: Date.now()
    }));
    
    showNotification('Entwurf gespeichert!', 'success');
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <i class="bi bi-${type === 'success' ? 'check-circle' : 'info-circle'}"></i>
        <span>${message}</span>
        <button type="button" onclick="this.parentElement.remove()">
            <i class="bi bi-x"></i>
        </button>
    `;
    
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 12px 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 250px;
    `;
    
    if (type === 'success') {
        notification.style.borderLeft = '4px solid var(--success-color)';
    }
    
    document.body.appendChild(notification);
    
    setTimeout(() => notification.remove(), 3000);
}

// Close modals when clicking outside
window.addEventListener('click', function(event) {
    const markdownModal = document.getElementById('markdownHelpModal');
    const deleteModal = document.getElementById('deleteModal');
    
    if (event.target === markdownModal) {
        closeMarkdownHelp();
    }
    
    if (event.target === deleteModal) {
        closeDeleteModal();
    }
});
</script>
{% endblock %}