<!-- webapp/internal/templates/forum/view_post.html -->
{% extends "base.html" %}

{% block title %}{{ post.title }} - Forum{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/forum.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/forum-view.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/forum-comments.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="forum-container">
        <!-- Navigation -->
        <div class="post-navigation">
            <a href="{{ url_for('forum.index') }}" class="nav-btn">
                <i class="bi bi-arrow-left"></i> Zur체ck zum Forum
            </a>
            <div class="post-actions-nav">
                {% if post.author_id == user.id or user.has_management_role() %}
                <a href="{{ url_for('forum.edit_post', post_id=post.id) }}" class="btn btn-secondary">
                    <i class="bi bi-pencil"></i> Bearbeiten
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Post Content -->
        <article class="post-detail">
            <header class="post-detail-header">
                <div class="post-title-section">
                    <h1 class="post-detail-title">{{ post.title }}</h1>
                    {% if post.category_name %}
                    <div class="post-category-info">
                        <a href="{{ url_for('forum.index', category=post.category_id) }}" class="post-category">
                            <i class="bi bi-tag"></i> {{ post.category_name }}
                        </a>
                    </div>
                    {% endif %}
                    
                    <!--{% if post.summary %}
                    <div class="post-summary">
                        <i class="bi bi-info-circle"></i>
                        {{ post.summary }}
                    </div>
                    {% endif %} -->
                </div>
                
                <div class="post-meta-section">
                    <div class="author-info">
                        <div class="author-avatar">
                            {% if post.author_avatar %}
                                <img src="{{ post.author_avatar }}" alt="Profilbild" class="profile-image">
                            {% else %}
                                <div class="profile-avatar-placeholder">
                                    {{ (post.author_display_name or post.author_name)[0].upper() }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="author-details">
                            <div class="author-name">{{ post.author_display_name or post.author_name }}</div>
                            <div class="post-timestamps">
                                <div class="post-date">
                                    <i class="bi bi-clock"></i>
                                    Erstellt {{ post.created_at|datetime_format }}
                                </div>
                                {% if post.updated_at and post.updated_at != post.created_at %}
                                <div class="post-updated">
                                    <i class="bi bi-pencil"></i>
                                    Bearbeitet {{ post.updated_at|datetime_format }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Post Content with Markdown -->
            <div class="post-content">
                <div class="content-body">
                    {% if post.content_html %}
                        {{ post.content_html|safe }}
                    {% else %}
                        {{ post.content|nl2br }}
                    {% endif %}
                </div>
            </div>

            <!-- Attachments -->
            {% if attachments %}
            <div class="post-attachments">
                <h3 class="attachments-title">
                    <i class="bi bi-paperclip"></i> 
                    Anh채nge ({{ attachments|length }})
                </h3>
                <div class="attachments-grid">
                    {% for attachment in attachments %}
                    <div class="attachment-item" data-attachment-id="{{ attachment.id }}">
                        <div class="attachment-icon">
                            {% set file_ext = attachment.original_filename.split('.')[-1].lower() %}
                            {% if file_ext in ['jpg', 'jpeg', 'png', 'gif'] %}
                                <i class="bi bi-image text-info"></i>
                            {% elif file_ext in ['pdf'] %}
                                <i class="bi bi-file-pdf text-danger"></i>
                            {% elif file_ext in ['doc', 'docx'] %}
                                <i class="bi bi-file-word text-primary"></i>
                            {% elif file_ext in ['xlsx', 'xls'] %}
                                <i class="bi bi-file-excel text-success"></i>
                            {% elif file_ext in ['pptx', 'ppt'] %}
                                <i class="bi bi-file-ppt text-warning"></i>
                            {% elif file_ext in ['zip', 'rar'] %}
                                <i class="bi bi-file-zip text-secondary"></i>
                            {% else %}
                                <i class="bi bi-file-earmark text-muted"></i>
                            {% endif %}
                        </div>
                        <div class="attachment-info">
                            <div class="attachment-name" title="{{ attachment.original_filename }}">
                                {{ attachment.original_filename }}
                            </div>
                            <div class="attachment-size">
                                {{ (attachment.file_size / 1024)|round(1) }} KB
                            </div>
                        </div>
                        <div class="attachment-actions">
                            {% if file_ext in ['jpg', 'jpeg', 'png', 'gif'] %}
                            <button type="button" class="btn btn-sm btn-outline" 
                                    onclick="previewImage({{ attachment.id }}, '{{ attachment.original_filename }}')"
                                    title="Vorschau">
                                <i class="bi bi-eye"></i>
                            </button>
                            {% endif %}
                            <a href="{{ url_for('forum.download_attachment', attachment_id=attachment.id) }}" 
                               class="btn btn-sm btn-primary" 
                               title="Herunterladen">
                                <i class="bi bi-download"></i>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Post Stats -->
            <div class="post-stats">
                {% if attachments %}
                <div class="stat-item">
                    <i class="bi bi-paperclip"></i>
                    <span>{{ attachments|length }} Anhang{% if attachments|length != 1 %}e{% endif %}</span>
                </div>
                {% endif %}
                <div class="stat-item">
                    <i class="bi bi-arrow-right"></i>
                    <i class="bi bi-chat-dots"></i>
                    <span id="commentCount">{{ comments|length }} Kommentar{% if comments|length != 1 %}e{% endif %}</span>
                </div>
            </div>
        </article>

        <!-- Comments Section -->
        <section class="comments-section">
            <div class="comments-header">
                <h2>
                    <i class="bi bi-chat-dots"></i> 
                    Kommentare ({{ comments|length }})
                </h2>
                <button type="button" class="btn btn-primary" onclick="showCommentForm(null)">
                    <i class="bi bi-plus-lg"></i> Kommentar hinzuf체gen
                </button>
            </div>

            <!-- New Comment Form -->
            <div id="commentForm" class="comment-form" style="display: none;">
                <div class="comment-form-header">
                    <h4 id="commentFormTitle">Neuer Kommentar</h4>
                    <button type="button" class="form-close-btn" onclick="hideCommentForm()">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
                <form id="newCommentForm" onsubmit="submitComment(event)">
                    <input type="hidden" id="parentCommentId" name="parent_id" value="">
                    <div class="form-group">
                        <textarea id="commentContent" 
                                  name="content" 
                                  class="form-textarea" 
                                  placeholder="Schreiben Sie Ihren Kommentar..."
                                  rows="4"
                                  maxlength="2000"
                                  required></textarea>
                        <div class="form-hint">
                            <span id="commentCounter">0/2000</span> Zeichen
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" id="submitCommentBtn">
                            <i class="bi bi-send"></i> Kommentar posten
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="hideCommentForm()">
                            <i class="bi bi-x"></i> Abbrechen
                        </button>
                    </div>
                </form>
            </div>

            <!-- Comments List -->
            <div class="comments-list">
                {% if comments %}
                    {% for comment in comments %}
                        {% include 'forum/comment_item.html' %}
                    {% endfor %}
                {% else %}
                    <div class="no-comments">
                        <div class="no-comments-icon">
                            <i class="bi bi-chat-dots"></i>
                        </div>
                        <h3>Noch keine Kommentare</h3>
                        <p>Seien Sie der Erste, der einen Kommentar hinterl채sst!</p>
                        <button type="button" class="btn btn-primary" onclick="showCommentForm(null)">
                            <i class="bi bi-plus-lg"></i> Ersten Kommentar schreiben
                        </button>
                    </div>
                {% endif %}
            </div>
        </section>
    </div>
</div>

<!-- Image Preview Modal -->
<div id="imageModal" class="modal" style="display: none;">
    <div class="modal-content image-modal-content">
        <div class="modal-header">
            <h3 id="modalImageTitle">Bildvorschau</h3>
            <div class="image-modal-actions">
                <button type="button" class="btn btn-primary" onclick="downloadCurrentImage()">
                    <i class="bi bi-download"></i> Herunterladen
                </button>
                <button type="button" class="modal-close" onclick="closeImageModal()">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        </div>
        <div class="modal-body image-modal-body">
            <img id="modalImage" src="" alt="Vorschau" class="preview-image">
        </div>
    </div>
</div>

{% endblock %}

{% block page_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
<script>
// Initialize highlighting for code blocks
document.addEventListener('DOMContentLoaded', function() {
    hljs.highlightAll();
    // Initialize comment counter
    updateCommentCounter();
});

// Comment functionality
let currentPostId = {{ post.id }};
let currentEditCommentId = null;

// Set global user info for comments
window.currentUserId = {{ user.id }};
window.currentUserName = "{{ user.display_name or user.username }}";
{% if user.avatar_url %}
window.currentUserAvatar = '<img src="{{ user.avatar_url }}" alt="Profilbild" class="profile-image">';
{% else %}
window.currentUserAvatar = '<div class="profile-avatar-placeholder">{{ (user.display_name or user.username)[0].upper() }}</div>';
{% endif %}

function showCommentForm(parentId = null) {
    const form = document.getElementById('commentForm');
    const title = document.getElementById('commentFormTitle');
    const parentInput = document.getElementById('parentCommentId');
    
    if (parentId) {
        title.textContent = 'Antwort verfassen';
        parentInput.value = parentId;
        
        // Insert form after the parent comment
        const parentComment = document.querySelector(`[data-comment-id="${parentId}"]`);
        if (parentComment) {
            parentComment.after(form);
        }
    } else {
        title.textContent = 'Neuer Kommentar';
        parentInput.value = '';
        
        // Move form to top of comments section
        const commentsHeader = document.querySelector('.comments-header');
        commentsHeader.after(form);
    }
    
    form.style.display = 'block';
    document.getElementById('commentContent').focus();
}

function hideCommentForm() {
    const form = document.getElementById('commentForm');
    form.style.display = 'none';
    
    // Clear form
    document.getElementById('commentContent').value = '';
    document.getElementById('parentCommentId').value = '';
    updateCommentCounter();
}

function updateCommentCounter() {
    const textarea = document.getElementById('commentContent');
    const counter = document.getElementById('commentCounter');
    
    if (textarea && counter) {
        const length = textarea.value.length;
        counter.textContent = `${length}/2000`;
        counter.className = length > 1900 ? 'counter-warning' : '';
    }
}

// Add event listener for comment counter
document.addEventListener('DOMContentLoaded', function() {
    const commentTextarea = document.getElementById('commentContent');
    if (commentTextarea) {
        commentTextarea.addEventListener('input', updateCommentCounter);
    }
});

async function submitComment(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    const submitBtn = document.getElementById('submitCommentBtn');
    
    // Show loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-hourglass"></i> Wird gepostet...';
    
    try {
        const response = await fetch(`/forum/post/${currentPostId}/comment`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Reload page to show new comment
            window.location.reload();
        } else {
            alert('Fehler beim Posten des Kommentars: ' + data.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Fehler beim Posten des Kommentars.');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-send"></i> Kommentar posten';
    }
}

// Image preview functionality
function previewImage(attachmentId, filename) {
    const modal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    const modalTitle = document.getElementById('modalImageTitle');
    
    modalTitle.textContent = filename;
    modalImage.src = `/static/uploads/forum/${attachmentId}_${filename}`;
    modalImage.setAttribute('data-attachment-id', attachmentId);
    modal.style.display = 'flex';
}

function closeImageModal() {
    document.getElementById('imageModal').style.display = 'none';
}

function downloadCurrentImage() {
    const attachmentId = document.getElementById('modalImage').getAttribute('data-attachment-id');
    window.location.href = `/forum/download/${attachmentId}`;
}

// Close modals when clicking outside
window.addEventListener('click', function(event) {
    const imageModal = document.getElementById('imageModal');
    const shareModal = document.getElementById('shareModal');
    
    if (event.target === imageModal) {
        closeImageModal();
    }
    
    if (event.target === shareModal) {
        closeShareModal();
    }
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeImageModal();
        closeShareModal();
        hideCommentForm();
    }
});

// Auto-save comment draft
let commentDraftTimer;
function saveCommentDraft() {
    const content = document.getElementById('commentContent').value;
    const parentId = document.getElementById('parentCommentId').value;
    
    if (content.trim()) {
        localStorage.setItem(`comment_draft_${currentPostId}_${parentId || 'root'}`, content);
    }
}

// Load comment draft
function loadCommentDraft(parentId = null) {
    const saved = localStorage.getItem(`comment_draft_${currentPostId}_${parentId || 'root'}`);
    if (saved) {
        document.getElementById('commentContent').value = saved;
        updateCommentCounter();
    }
}

// Auto-save functionality
document.addEventListener('DOMContentLoaded', function() {
    const commentTextarea = document.getElementById('commentContent');
    if (commentTextarea) {
        commentTextarea.addEventListener('input', function() {
            clearTimeout(commentDraftTimer);
            commentDraftTimer = setTimeout(saveCommentDraft, 2000);
        });
    }
});

</script>
{% endblock %}