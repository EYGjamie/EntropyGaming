<!-- webapp/internal/templates/forum/create_post.html -->
{% extends "base.html" %}

{% block title %}{% if post %}Post bearbeiten{% else %}Neuer Post{% endif %} - Forum{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/forum.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/forum-editor.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/markdown-enhanced.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="forum-editor-container">
        <div class="editor-header">
            <h1>
                <i class="bi bi-pencil"></i> 
                {% if post %}Post bearbeiten{% else %}Neuer Post{% endif %}
            </h1>
            <a href="{% if post %}{{ url_for('forum.view_post', post_id=post.id) }}{% else %}{{ url_for('forum.index') }}{% endif %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Zur√ºck
            </a>
        </div>

        <form method="POST" enctype="multipart/form-data" id="postForm" class="editor-form">
            <div class="form-layout">
                <!-- Left Column: Main Editor -->
                <div class="editor-main">
                    <!-- Basic Information -->
                    <div class="form-section">
                        <div class="form-section-header">
                            <h3><i class="bi bi-info-circle"></i> Grundinformationen</h3>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="title" class="form-label">
                                    <i class="bi bi-type"></i> Titel *
                                </label>
                                <input type="text" 
                                       id="title" 
                                       name="title" 
                                       class="form-input" 
                                       placeholder="Gib deinem Post einen aussagekr√§ftigen Titel..."
                                       value="{% if post %}{{ post.title }}{% endif %}"
                                       maxlength="255"
                                       required>
                                <div class="form-hint">
                                    <span id="titleCounter">{% if post %}{{ post.title|length }}{% else %}0{% endif %}/255</span> Zeichen
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="category_id" class="form-label">
                                    <i class="bi bi-tag"></i> Kategorie
                                </label>
                                <select id="category_id" name="category_id" class="form-select">
                                    <option value="">-- Keine Kategorie --</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}" 
                                            {% if post and post.category_id == category.id %}selected{% endif %}>
                                        {{ category.name }}
                                        {% if category.required_roles %}
                                        <span class="category-restricted">üîí</span>
                                        {% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-hint">Optional: Ordne deinen Post einer Kategorie zu</div>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Section -->
                    <div class="form-section">
                        <div class="form-section-header">
                            <h3><i class="bi bi-card-text"></i> Kurzzusammenfassung</h3>
                            <button type="button" class="btn btn-ai" id="generateSummaryBtn">
                                <i class="bi bi-magic"></i> AI generieren
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <textarea id="summary" 
                                      name="summary" 
                                      class="form-textarea summary-input" 
                                      placeholder="Eine kurze Zusammenfassung deines Posts (max. 150 Zeichen)..."
                                      maxlength="150"
                                      rows="3">{% if post %}{{ post.summary }}{% endif %}</textarea>
                            <div class="form-hint">
                                <span id="summaryCounter">{% if post and post.summary %}{{ post.summary|length }}{% else %}0{% endif %}/150</span> Zeichen
                                <div class="ai-status" id="aiStatus" style="display: none;">
                                    <i class="bi bi-robot"></i> <span class="status-text">Wird generiert...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Content Editor -->
                    <div class="form-section">
                        <div class="form-section-header">
                            <h3><i class="bi bi-file-text"></i> Inhalt *</h3>
                            <div class="editor-mode-toggle">
                                <button type="button" class="mode-btn active" data-mode="write">
                                    <i class="bi bi-pencil"></i> Schreiben
                                </button>
                                <button type="button" class="mode-btn" data-mode="preview">
                                    <i class="bi bi-eye"></i> Vorschau
                                </button>
                            </div>
                        </div>

                        <!-- Formatting Toolbar -->
                        <div class="markdown-toolbar">
                            <div class="toolbar-group">
                                <button type="button" class="toolbar-btn" data-action="bold" title="Fett (Ctrl+B)">
                                    <i class="bi bi-type-bold"></i>
                                </button>
                                <button type="button" class="toolbar-btn" data-action="italic" title="Kursiv (Ctrl+I)">
                                    <i class="bi bi-type-italic"></i>
                                </button>
                                <!-- <button type="button" class="toolbar-btn" data-action="strikethrough" title="Durchgestrichen">
                                    <i class="bi bi-type-strikethrough"></i>
                                </button> -->
                                <button type="button" class="toolbar-btn" data-action="code" title="Code">
                                    <i class="bi bi-code"></i>
                                </button>
                            </div>
                            
                            <div class="toolbar-group">
                                <button type="button" class="toolbar-btn" data-action="heading" title="√úberschrift">
                                    <i class="bi bi-type-h1"></i>
                                </button>
                                <button type="button" class="toolbar-btn" data-action="quote" title="Zitat">
                                    <i class="bi bi-chat-square-quote"></i>
                                </button>
                                <button type="button" class="toolbar-btn" data-action="list" title="Liste">
                                    <i class="bi bi-list-ul"></i>
                                </button>
                                <button type="button" class="toolbar-btn" data-action="ordered-list" title="Nummerierte Liste">
                                    <i class="bi bi-list-ol"></i>
                                </button>
                                <button type="button" class="toolbar-btn" data-action="task-list" title="Aufgabenliste">
                                    <i class="bi bi-check2-square"></i>
                                </button>
                                <button type="button" class="toolbar-btn" data-action="codeblock" title="Codeblock">
                                    <i class="bi bi-code-square"></i>
                                </button>
                            </div>
                            
                            <div class="toolbar-group">
                                <button type="button" class="toolbar-btn" data-action="link" title="Link">
                                    <i class="bi bi-link-45deg"></i>
                                </button>
                                <button type="button" class="toolbar-btn" data-action="image" title="Bild">
                                    <i class="bi bi-image"></i>
                                </button>
                                <button type="button" class="toolbar-btn" data-action="table" title="Tabelle">
                                    <i class="bi bi-table"></i>
                                </button>
                            </div>
                            
                            <div class="toolbar-group">
                                <button type="button" class="toolbar-btn" data-action="help" title="Markdown Hilfe">
                                    <i class="bi bi-question-circle"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Editor Area -->
                        <div class="editor-area">
                            <textarea id="content" 
                                      name="content" 
                                      class="form-textarea markdown-editor" 
                                      placeholder="Schreibe hier den Inhalt deines Posts... Du kannst Markdown verwenden!"
                                      rows="20"
                                      required>{% if post %}{{ post.content }}{% endif %}</textarea>
                            
                            <div id="preview" class="markdown-preview" style="display: none;">
                                <div class="preview-content">
                                    <p class="text-muted"><i class="bi bi-eye"></i> Vorschau wird geladen...</p>
                                </div>
                            </div>
                        </div>

                        <div class="editor-footer">
                            <div class="editor-stats">
                                <span id="wordCount">0 W√∂rter</span>
                                <span id="charCount">0 Zeichen</span>
                            </div>
                            <div class="markdown-hint">
                                <i class="bi bi-info-circle"></i>
                                <a href="#" onclick="showMarkdownHelp()">Markdown Syntax</a> wird unterst√ºtzt
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Settings & Attachments -->
                <div class="editor-sidebar">
                    <!-- Attachments -->
                    <div class="sidebar-section">
                        <div class="sidebar-section-header">
                            <h4><i class="bi bi-paperclip"></i> Anh√§nge</h4>
                        </div>
                        
                        <div class="attachments-area">
                            <div class="file-upload-area" id="fileUploadArea">
                                <input type="file" 
                                       name="attachments" 
                                       id="attachments" 
                                       multiple 
                                       accept=".txt,.pdf,.png,.jpg,.jpeg,.gif,.doc,.docx,.xlsx,.pptx,.zip,.rar"
                                       class="file-input">
                                <label for="attachments" class="file-upload-label">
                                    <i class="bi bi-cloud-upload"></i>
                                    <span>Dateien hier hinziehen oder klicken</span>
                                    <small>Max. 10MB pro Datei</small>
                                </label>
                            </div>
                            
                            <div id="fileList" class="file-list">
                                <!-- Existing attachments (for edit mode) -->
                                {% if post and attachments %}
                                    {% for attachment in attachments %}
                                    <div class="file-item existing-file" data-attachment-id="{{ attachment.id }}">
                                        <div class="file-info">
                                            <i class="bi bi-file-earmark"></i>
                                            <span class="filename">{{ attachment.original_filename }}</span>
                                            <span class="filesize">{{ (attachment.file_size / 1024)|round(1) }} KB</span>
                                        </div>
                                        <button type="button" class="remove-file-btn" onclick="removeExistingFile({{ attachment.id }})">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="bi bi-send"></i> 
                        {% if post %}√Ñnderungen speichern{% else %}Post ver√∂ffentlichen{% endif %}
                    </button>      
                </div>
            </div>
        </form>
    </div>
</div>

<div id="markdownHelpModal" class="modal" style="display: none;">
    <div class="modal-content large-modal">
        <div class="modal-header">
            <h3><i class="bi bi-book"></i> Markdown Syntax Hilfe</h3>
            <button type="button" class="modal-close" onclick="closeMarkdownHelp()">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="markdown-help-content">
                
                <!-- Text Formatting -->
                <div class="help-section">
                    <h4><i class="bi bi-type"></i> Text-Formatierung</h4>
                    <div class="help-examples">
                        <div class="help-item">
                            <code>**fett**</code> ‚Üí <strong>fett</strong>
                        </div>
                        <div class="help-item">
                            <code>*kursiv*</code> ‚Üí <em>kursiv</em>
                        </div>
                        <div class="help-item">
                            <code>~~durchgestrichen~~</code> ‚Üí <del>durchgestrichen</del>
                        </div>
                        <div class="help-item">
                            <code>`Code`</code> ‚Üí <code>Code</code>
                        </div>
                    </div>
                </div>

                <!-- Headers -->
                <div class="help-section">
                    <h4><i class="bi bi-hash"></i> √úberschriften</h4>
                    <div class="help-examples">
                        <div class="help-item">
                            <code># √úberschrift 1</code>
                        </div>
                        <div class="help-item">
                            <code>## √úberschrift 2</code>
                        </div>
                        <div class="help-item">
                            <code>### √úberschrift 3</code>
                        </div>
                    </div>
                </div>

                <!-- Lists -->
                <div class="help-section">
                    <h4><i class="bi bi-list-ul"></i> Listen</h4>
                    <div class="help-examples">
                        <div class="help-item">
                            <strong>Ungeordnete Liste:</strong><br>
                            <code>- Element 1<br>- Element 2<br>&nbsp;&nbsp;- Unterelement</code>
                        </div>
                        <div class="help-item">
                            <strong>Geordnete Liste:</strong><br>
                            <code>1. Erstes Element<br>2. Zweites Element</code>
                        </div>
                        <div class="help-item">
                            <strong>Aufgabenliste:</strong><br>
                            <code>- [ ] Offene Aufgabe<br>- [x] Erledigte Aufgabe</code>
                        </div>
                    </div>
                </div>

                <!-- Tables -->
                <div class="help-section">
                    <h4><i class="bi bi-table"></i> Tabellen</h4>
                    <div class="help-examples">
                        <div class="help-item">
                            <code>| Spalte 1 | Spalte 2 |<br>|----------|----------|<br>| Inhalt 1 | Inhalt 2 |</code>
                        </div>
                    </div>
                </div>

                <!-- Links and Images -->
                <div class="help-section">
                    <h4><i class="bi bi-link-45deg"></i> Links & Bilder</h4>
                    <div class="help-examples">
                        <div class="help-item">
                            <code>[Link Text](https://beispiel.de)</code>
                        </div>
                        <div class="help-item">
                            <code>![Alt Text](bild-url.jpg)</code>
                        </div>
                    </div>
                </div>

                <!-- Code Blocks -->
                <div class="help-section">
                    <h4><i class="bi bi-code-square"></i> Code-Bl√∂cke</h4>
                    <div class="help-examples">
                        <div class="help-item">
                            <code>```python<br>def hello():<br>&nbsp;&nbsp;&nbsp;&nbsp;print("Hello World")<br>```</code>
                        </div>
                    </div>
                </div>

                <!-- Mathematical Expressions -->
                <div class="help-section">
                    <h4><i class="bi bi-calculator"></i> Mathematik</h4>
                    <div class="help-examples">
                        <div class="help-item">
                            <strong>Inline:</strong> <code>$x^2 + y^2 = z^2$</code>
                        </div>
                        <div class="help-item">
                            <strong>Block:</strong><br>
                            <code>$$<br>E = mc^2<br>$$</code>
                        </div>
                    </div>
                </div>

                <!-- Footnotes -->
                <div class="help-section">
                    <h4><i class="bi bi-journal-text"></i> Fu√ünoten</h4>
                    <div class="help-examples">
                        <div class="help-item">
                            <code>Text mit Fu√ünote[^1]<br><br>[^1]: Dies ist die Fu√ünote</code>
                        </div>
                    </div>
                </div>

                <!-- Definition Lists -->
                <div class="help-section">
                    <h4><i class="bi bi-card-list"></i> Definitionslisten</h4>
                    <div class="help-examples">
                        <div class="help-item">
                            <code>Begriff 1<br>:&nbsp;&nbsp;&nbsp;Definition des ersten Begriffs<br><br>Begriff 2<br>:&nbsp;&nbsp;&nbsp;Definition des zweiten Begriffs</code>
                        </div>
                    </div>
                </div>

                <!-- Mermaid Diagrams -->
                <div class="help-section">
                    <h4><i class="bi bi-diagram-3"></i> Mermaid-Diagramme</h4>
                    <div class="help-examples">
                        <div class="help-item">
                            <strong>Flussdiagramm:</strong><br>
                            <code>```mermaid<br>graph TD<br>&nbsp;&nbsp;&nbsp;&nbsp;A[Start] --> B{Entscheidung}<br>&nbsp;&nbsp;&nbsp;&nbsp;B -->|Ja| C[Aktion 1]<br>&nbsp;&nbsp;&nbsp;&nbsp;B -->|Nein| D[Aktion 2]<br>```</code>
                        </div>
                        <div class="help-item">
                            <strong>Sequenzdiagramm:</strong><br>
                            <code>```mermaid<br>sequenceDiagram<br>&nbsp;&nbsp;&nbsp;&nbsp;Alice->>Bob: Hallo Bob<br>&nbsp;&nbsp;&nbsp;&nbsp;Bob-->>Alice: Hallo Alice<br>```</code>
                        </div>
                    </div>
                </div>

                <!-- Blockquotes -->
                <div class="help-section">
                    <h4><i class="bi bi-chat-quote"></i> Zitate</h4>
                    <div class="help-examples">
                        <div class="help-item">
                            <code>> Dies ist ein Zitat<br>> mit mehreren Zeilen</code>
                        </div>
                    </div>
                </div>

                <!-- Advanced Features -->
                <div class="help-section">
                    <h4><i class="bi bi-gear"></i> Erweiterte Features</h4>
                    <div class="help-examples">
                        <div class="help-item">
                            <strong>Horizontal Line:</strong> <code>---</code>
                        </div>
                        <div class="help-item">
                            <strong>Escape Characters:</strong> <code>\*nicht kursiv\*</code>
                        </div>
                        <div class="help-item">
                            <strong>Admonitions:</strong><br>
                            <code>!!! note "Hinweis"<br>&nbsp;&nbsp;&nbsp;&nbsp;Dies ist ein Hinweis</code>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeMarkdownHelp()">
                Schlie√üen
            </button>
            <a href="https://www.markdownguide.org/" target="_blank" class="btn btn-outline">
                <i class="bi bi-box-arrow-up-right"></i> Erweiterte Dokumentation
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block page_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
<script src="{{ url_for('static', filename='js/forum-editor-enhanced.js') }}"></script>
<script>
// Editor functionality
class ForumEditor {
    constructor() {
        this.contentEditor = document.getElementById('content');
        this.previewArea = document.getElementById('preview');
        this.currentMode = 'write';
        this.initializeEditor();
        this.initializeFileUpload();
        this.initializeCounters();
        this.setupAutoSave();
    }
    
    initializeEditor() {
        // Toolbar event listeners
        document.querySelectorAll('.toolbar-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const action = btn.getAttribute('data-action');
                this.handleToolbarAction(action);
            });
        });
        
        // Mode toggle
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const mode = btn.getAttribute('data-mode');
                this.switchMode(mode);
            });
        });
        
        // Keyboard shortcuts
        this.contentEditor.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'b':
                        e.preventDefault();
                        this.handleToolbarAction('bold');
                        break;
                    case 'i':
                        e.preventDefault();
                        this.handleToolbarAction('italic');
                        break;
                }
            }
        });
        
        // Live preview update
        this.contentEditor.addEventListener('input', () => {
            this.updatePreview();
            this.updateCounters();
        });
    }
    
    switchMode(mode) {
        const writeModeBtn = document.querySelector('.mode-btn[data-mode="write"]');
        const previewModeBtn = document.querySelector('.mode-btn[data-mode="preview"]');
        
        if (mode === 'write') {
            this.currentMode = 'write';
            this.contentEditor.style.display = 'block';
            this.previewArea.style.display = 'none';
            writeModeBtn.classList.add('active');
            previewModeBtn.classList.remove('active');
        } else {
            this.currentMode = 'preview';
            this.contentEditor.style.display = 'none';
            this.previewArea.style.display = 'block';
            writeModeBtn.classList.remove('active');
            previewModeBtn.classList.add('active');
            this.updatePreview();
        }
    }
    
    updatePreview() {
        if (this.currentMode === 'preview') {
            const content = this.contentEditor.value;
            const html = marked.parse(content);
            this.previewArea.querySelector('.preview-content').innerHTML = html;
            
            // Highlight code blocks
            this.previewArea.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        }
    }
    
    handleToolbarAction(action) {
        const start = this.contentEditor.selectionStart;
        const end = this.contentEditor.selectionEnd;
        const selectedText = this.contentEditor.value.substring(start, end);
        let replacement = '';
        
        switch(action) {
            case 'bold':
                replacement = `**${selectedText || 'fetter Text'}**`;
                break;
            case 'italic':
                replacement = `*${selectedText || 'kursiver Text'}*`;
                break;
            case 'strikethrough':
                replacement = `~~${selectedText || 'durchgestrichener Text'}~~`;
                break;
            case 'heading':
                replacement = `## ${selectedText || '√úberschrift'}`;
                break;
            case 'quote':
                replacement = `> ${selectedText || 'Zitat'}`;
                break;
            case 'code':
                replacement = `\`${selectedText || 'code'}\``;
                break;
            case 'codeblock':
                replacement = `\`\`\`\n${selectedText || 'code hier'}\n\`\`\``;
                break;
            case 'link':
                const url = prompt('URL eingeben:') || 'http://example.com';
                replacement = `[${selectedText || 'Link Text'}](${url})`;
                break;
            case 'image':
                const imgUrl = prompt('Bild URL eingeben:') || 'image.jpg';
                replacement = `![${selectedText || 'Alt Text'}](${imgUrl})`;
                break;
            case 'list':
                replacement = `- ${selectedText || 'Listenpunkt'}`;
                break;
            case 'table':
                replacement = `| Spalte 1 | Spalte 2 |\n|----------|----------|\n| Zelle 1  | Zelle 2  |`;
                break;
            case 'help':
                showMarkdownHelp();
                return;
        }
        
        if (replacement) {
            this.insertAtCursor(replacement);
        }
    }
    
    insertAtCursor(text) {
        const start = this.contentEditor.selectionStart;
        const end = this.contentEditor.selectionEnd;
        const value = this.contentEditor.value;
        
        this.contentEditor.value = value.substring(0, start) + text + value.substring(end);
        this.contentEditor.focus();
        
        // Set cursor position
        const newPosition = start + text.length;
        this.contentEditor.setSelectionRange(newPosition, newPosition);
        
        this.updateCounters();
    }
    
    initializeFileUpload() {
        const fileInput = document.getElementById('attachments');
        const uploadArea = document.getElementById('fileUploadArea');
        const fileList = document.getElementById('fileList');
        
        // Drag and drop functionality
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            const files = Array.from(e.dataTransfer.files);
            this.handleFiles(files);
        });
        
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            this.handleFiles(files);
        });
    }
    
    handleFiles(files) {
        const fileList = document.getElementById('fileList');
        
        files.forEach(file => {
            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                alert(`Datei "${file.name}" ist zu gro√ü (max. 10MB)`);
                return;
            }
            
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <div class="file-info">
                    <i class="bi bi-file-earmark"></i>
                    <span class="filename">${file.name}</span>
                    <span class="filesize">${(file.size / 1024).toFixed(1)} KB</span>
                </div>
                <button type="button" class="remove-file-btn" onclick="this.parentElement.remove()">
                    <i class="bi bi-x"></i>
                </button>
            `;
            fileList.appendChild(fileItem);
        });
    }
    
    initializeCounters() {
        // Title counter
        const titleInput = document.getElementById('title');
        const titleCounter = document.getElementById('titleCounter');
        
        titleInput.addEventListener('input', () => {
            const length = titleInput.value.length;
            titleCounter.textContent = `${length}/255`;
            titleCounter.className = length > 240 ? 'counter-warning' : '';
        });
        
        // Summary counter
        const summaryInput = document.getElementById('summary');
        const summaryCounter = document.getElementById('summaryCounter');
        
        summaryInput.addEventListener('input', () => {
            const length = summaryInput.value.length;
            summaryCounter.textContent = `${length}/150`;
            summaryCounter.className = length > 140 ? 'counter-warning' : '';
        });
        
        // Initial count update
        this.updateCounters();
    }
    
    updateCounters() {
        const content = this.contentEditor.value;
        const wordCount = content.trim() ? content.trim().split(/\s+/).length : 0;
        const charCount = content.length;
        
        document.getElementById('wordCount').textContent = `${wordCount} W√∂rter`;
        document.getElementById('charCount').textContent = `${charCount} Zeichen`;
    }
    
    setupAutoSave() {
        let autoSaveTimer;
        
        this.contentEditor.addEventListener('input', () => {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                this.saveToLocalStorage();
            }, 5000); // Auto-save after 5 seconds of inactivity
        });
        
        // Load from localStorage on page load
        this.loadFromLocalStorage();
    }
    
    saveToLocalStorage() {
        const data = {
            title: document.getElementById('title').value,
            content: this.contentEditor.value,
            summary: document.getElementById('summary').value,
            category: document.getElementById('category_id').value,
            timestamp: Date.now()
        };
        
        localStorage.setItem('forum_post_draft', JSON.stringify(data));
    }
    
    loadFromLocalStorage() {
        const saved = localStorage.getItem('forum_post_draft');
        if (saved && !document.getElementById('title').value) { // Only load if form is empty
            const data = JSON.parse(saved);
            if (Date.now() - data.timestamp < 86400000) { // Only if less than 24 hours old
                if (confirm('Es wurde ein gespeicherter Entwurf gefunden. M√∂chten Sie ihn laden?')) {
                    document.getElementById('title').value = data.title || '';
                    this.contentEditor.value = data.content || '';
                    document.getElementById('summary').value = data.summary || '';
                    document.getElementById('category_id').value = data.category || '';
                    this.updateCounters();
                }
            }
        }
    }
}

// AI Summary Generation
async function generateSummary() {
    const content = document.getElementById('content').value.trim();
    const summaryInput = document.getElementById('summary');
    const generateBtn = document.getElementById('generateSummaryBtn');
    const aiStatus = document.getElementById('aiStatus');
    
    if (!content) {
        alert('Bitte geben Sie zuerst den Inhalt des Posts ein.');
        return;
    }
    
    // Show loading state
    generateBtn.disabled = true;
    generateBtn.innerHTML = '<i class="bi bi-hourglass"></i> Generiert...';
    aiStatus.style.display = 'flex';
    aiStatus.querySelector('.status-text').textContent = 'Zusammenfassung wird generiert...';
    
    try {
        const response = await fetch('/forum/generate-summary', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ content: content })
        });
        
        const data = await response.json();
        
        if (data.success) {
            summaryInput.value = data.summary;
            summaryInput.dispatchEvent(new Event('input')); // Trigger counter update
            aiStatus.querySelector('.status-text').textContent = 'Zusammenfassung generiert!';
            aiStatus.style.color = 'var(--success-color)';
            
            setTimeout(() => {
                aiStatus.style.display = 'none';
                aiStatus.style.color = '';
            }, 3000);
        } else {
            throw new Error(data.error || 'Unbekannter Fehler');
        }
    } catch (error) {
        console.error('Error generating summary:', error);
        aiStatus.querySelector('.status-text').textContent = 'Fehler beim Generieren: ' + error.message;
        aiStatus.style.color = 'var(--error-color)';
        
        setTimeout(() => {
            aiStatus.style.display = 'none';
            aiStatus.style.color = '';
        }, 5000);
    } finally {
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<i class="bi bi-magic"></i> AI generieren';
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    new ForumEditor();
    
    // Generate summary button
    document.getElementById('generateSummaryBtn').addEventListener('click', generateSummary);
    
    // Form validation
    document.getElementById('postForm').addEventListener('submit', function(e) {
        const title = document.getElementById('title').value.trim();
        const content = document.getElementById('content').value.trim();
        
        if (!title || !content) {
            e.preventDefault();
            alert('Bitte f√ºllen Sie Titel und Inhalt aus.');
            return;
        }
        
        // Clear localStorage on successful submit
        localStorage.removeItem('forum_post_draft');
    });
});

// Helper functions
function showMarkdownHelp() {
    document.getElementById('markdownHelpModal').style.display = 'flex';
}

function closeMarkdownHelp() {
    document.getElementById('markdownHelpModal').style.display = 'none';
}

function saveDraft() {
    const editor = new ForumEditor();
    editor.saveToLocalStorage();
    alert('Entwurf gespeichert!');
}

function removeExistingFile(attachmentId) {
    if (confirm('Datei wirklich entfernen?')) {
        fetch(`/forum/delete-attachment/${attachmentId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelector(`[data-attachment-id="${attachmentId}"]`).remove();
            } else {
                alert('Fehler beim Entfernen der Datei: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Fehler beim Entfernen der Datei.');
        });
    }
}

// Close modal when clicking outside
window.addEventListener('click', function(event) {
    const modal = document.getElementById('markdownHelpModal');
    if (event.target === modal) {
        closeMarkdownHelp();
    }
});
</script>
{% endblock %}