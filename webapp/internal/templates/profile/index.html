{% extends "base.html" %}

{% block title %}
    {% if is_own_profile %}
        Mein Profil - {{ g.user.effective_name }}
    {% else %}
        Profil - {{ user.effective_name }}
    {% endif %}
{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Profile Header -->
    <div class="profile-header mb-4">
        <div class="row align-items-center">
            <div class="col-auto"></div>
                <div class="profile-avatar-large">
                    {% if user.avatar_url %}
                        <img src="{{ user.avatar_url }}" 
                             alt="Profilbild" class="profile-image">
                    {% else %}
                        <div class="profile-avatar-placeholder">
                            {{ user.username[0].upper() }}
                        </div>
                    {% endif %}
                </div>
            </div>
            <div class="col">
                <h1 class="profile-name gradient-text">
                    {{ user.effective_name }}
                </h1>
                <p class="profile-username">{{ user.username }}</p>
                
                {% if roles %}
                    {% set top_role = roles | top_role %}
                    {% if top_role %}
                    <div class="profile-roles mb-3">
                        <span class="badge {{ top_role | role_badge_class }} role-badge-large">
                            {{ top_role }}
                        </span>
                    </div>
                    {% endif %}
                {% endif %}
                
                {% if user.description %}
                <p class="profile-description">{{ user.description }}</p>
                {% endif %}
                
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Profile Information -->
        <div class="col-lg-8 mb-4">
            <div class="card entropy-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="bi bi-person-circle"></i>
                        {% if is_own_profile %}
                            Profil-Informationen
                        {% else %}
                            Benutzer-Informationen
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="profile-info-item">
                                <label>Benutzername:</label>
                                <span>{{ user.username }}</span>
                            </div>
                        </div>
                        {% if user.display_name %}
                        <div class="col-md-6">
                            <div class="profile-info-item">
                                <label>Display Name:</label>
                                <span>{{ user.display_name }}</span>
                            </div>
                        </div>
                        {% endif %}
                        {% if user.nickname %}
                        <div class="col-md-6">
                            <div class="profile-info-item">
                                <label>Nickname:</label>
                                <span>{{ user.nickname }}</span>
                            </div>
                        </div>
                        {% endif %}
                        <div class="col-md-6">
                            <div class="profile-info-item">
                                <label>Discord ID:</label>
                                <span class="text-monospace">{{ user.discord_id }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="entropy-divider">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="profile-info-item">
                                <label>E-Mail:</label>
                                <span>{{ user.email or 'Nicht angegeben' }}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="profile-info-item">
                                <label>Telefon:</label>
                                <span>{{ user.phone or 'Nicht angegeben' }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Roles & Stats -->
        <div class="col-lg-4 mb-4">
            <div class="card entropy-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="bi bi-shield-check"></i>
                        Rollen & Berechtigungen
                    </h5>
                </div>
                <div class="card-body">
                    {% if roles %}
                    <div class="roles-list">
                        {% for role in roles %}
                        <div class="role-item">
                            <span class="badge {{ role | role_badge_class }} me-2">{{ role }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted">Keine besonderen Rollen zugewiesen.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Aktionen 
            {% if is_own_profile %}
            <div class="card entropy-card mt-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="bi bi-gear"></i>
                        Aktionen
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('profile.edit') }}" class="btn btn-outline-danger">
                            <i class="bi bi-pencil"></i> Profil bearbeiten
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}-->
        </div>
    </div>

    <!-- Activity Log -->
    {% if user_activity and user_activity.activities %}
    <div class="row">
        <div class="col-12">
            <div class="card entropy-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="bi bi-clock-history"></i>
                        {% if is_own_profile %}
                            Meine Aktivitäten
                        {% else %}
                            Benutzer-Aktivitäten (letzte 10)
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="activity-log">
                        {% for activity in user_activity.activities %}
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="bi bi-circle-fill"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-action">{{ activity.action }}</div>
                                {% if activity.details %}
                                <div class="activity-details">{{ activity.details }}</div>
                                {% endif %}
                                <div class="activity-time">{{ activity.created_at }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if error %}
    <div class="alert alert-danger" role="alert">
        <i class="bi bi-exclamation-triangle"></i>
        {{ error }}
    </div>
    {% endif %}
</div>

{% if not is_own_profile %}
<div class="floating-back-btn">
    <a href="{{ url_for('dashboard.index') }}" class="btn btn-entropy-round">
        <i class="bi bi-arrow-left"></i>
    </a>
</div>
{% endif %}
{% endblock %}

{% block page_js %}
<script>
// Copy profile link to clipboard
function copyProfileLink() {
    const url = "{{ url_for('profile.view_profile', user_id=user.id, _external=True) }}";
    navigator.clipboard.writeText(url).then(() => {
        // Show success message
        const toast = new bootstrap.Toast(document.querySelector('#copyToast'));
        toast.show();
    });
}
</script>

<!-- Toast for copy confirmation -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="copyToast" class="toast" role="alert">
        <div class="toast-header">
            <i class="bi bi-check-circle text-success me-2"></i>
            <strong class="me-auto">Link kopiert</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
            Profil-Link wurde in die Zwischenablage kopiert.
        </div>
    </div>
</div>
{% endblock %}